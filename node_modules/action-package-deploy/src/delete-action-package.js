#!/usr/bin/env node

const yargs = require("yargs");
const actionApis = require("./action-apis");
const logger = require("./logger");

const options = yargs
    .usage("Usage: -p <PackageId>")
    .option("p", { alias: "package-id", describe: "Action package ID", type: "string", demandOption: true })
    .option("e", { alias: "endpoint", describe: "Action platform endpoint", type: "string", default: "https://actions.office365.com" })
    .option("l", { alias: "log-level", describe: "Log level", choices: ["status", "info", "debug", "none"], default: "info" })
    .argv;

logger.setLogLevel(options["l"]);

async function deleteActionPackage(endpoint, packageId) {
    logger.logInfo(`Deleting package ...`);
    var monitorResponse = await actionApis.deleteActionPackage(endpoint, packageId);

    logger.logInfo(`Monitoring status ...`);
    var statusResponse = await actionApis.monitorStatusUrl(monitorResponse.url);
    if (statusResponse && statusResponse.status == "Completed" && statusResponse.message.startsWith("SUCCESS:")) {
        logger.logSuccess(statusResponse.message);
    } else {
        logger.logError(statusResponse.message);
    }
}

deleteActionPackage(options["e"], options["p"]);